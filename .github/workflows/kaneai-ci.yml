name: Run HyperExecute Job Manually

on:
  workflow_dispatch:
    inputs:
      test_run_id:
        description: 'Test Run ID'
        required: true
        type: string
      region:
        description: 'Region (e.g. eastus, centralindia)'
        required: true
        type: string
      title:
        description: 'Unique Build Title'
        required: true
        type: string

jobs:
  run-hyperexecute:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger HyperExecute Job
        id: trigger
        run: |
          response=$(curl --silent --location 'https://test-manager-api.lambdatest.com/api/atm/v1/hyperexecute' \
            --header 'Content-Type: application/json' \
            --header 'Authorization: Basic ${{ secrets.LT_AUTH_BASE64 }}' \
            --data '{
              "test_run_id": "${{ github.event.inputs.test_run_id }}",
              "concurrency": 1,
              "title": "${{ github.event.inputs.title }}",
              "region": "${{ github.event.inputs.region }}"
            }')

          echo "Response: $response"
          
          job_id=$(echo "$response" | jq -r '.job_id // empty')
          
          if [[ -z "$job_id" ]]; then
            echo "âŒ Error: job_id not found in the response. Exiting..."
            exit 1
          fi

          echo "âœ… Job ID: $job_id"
          echo "job_id=$job_id" >> $GITHUB_OUTPUT

      - name: Wait for 5 minutes
        run: |
          echo "â³ Waiting for 5 minutes before checking status..."
          sleep 300

      - name: Fetch and Print Job Status
        run: |
          job_id=${{ steps.trigger.outputs.job_id }}
          echo "ğŸ“¡ Fetching status for job ID: $job_id"

          status_response=$(curl -s -X GET "https://api.hyperexecute.cloud/v2.0/job/$job_id" \
            -H "accept: application/json")

          echo "Status Response: $status_response"

          # Check if response contains expected JSON
          if echo "$status_response" | jq empty 2>/dev/null; then
            status=$(echo "$status_response" | jq -r '.status')
            echo "âœ… Job Status: $status"
          else
            echo "âŒ Error: Invalid JSON response. Raw response:"
            echo "$status_response"
            exit 1
          fi
